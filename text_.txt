// MainForm.cs
using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Windows.Forms;
using Emgu.CV;
using Emgu.CV.Structure;
using Emgu.CV.CvEnum;
using FaceDetectionApp.Models;

namespace FaceDetectionApp
{
    public partial class MainForm : Form
    {
        private VideoCapture _capture = null;
        private CascadeClassifier _faceCascade;
        private bool isNewStudentMode = true;
        private List<Student> studentList = new List<Student>();
        private string selectedClass = null;

        public MainForm()
        {
            InitializeComponent();
            InitializeCamera();
            LoadClasses();
        }

        // Tạo camera và phát hiện khuôn mặt
        private void InitializeCamera()
        {
            try
            {
                _capture = new VideoCapture(0);
                _faceCascade = new CascadeClassifier("haarcascade_frontalface_default.xml");
                Application.Idle += ProcessFrame;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi không thể khởi tạo camera: " + ex.Message);
            }
        }

        // Tải danh sách lớp học từ cơ sở dữ liệu
        private void LoadClasses()
        {
            using (var db = new FaceDetectionAppContext())
            {
                var classes = db.GetStudents().Select(s => s.Class).Distinct().ToList();
                cmbClass.DataSource = classes;
                cmbClass.SelectedIndexChanged += CmbClass_SelectedIndexChanged;
            }
        }

        private void CmbClass_SelectedIndexChanged(object sender, EventArgs e)
        {
            selectedClass = cmbClass.SelectedItem.ToString();
            LoadStudentList();
        }

        private void LoadStudentList()
        {
            using (var db = new FaceDetectionAppContext())
            {
                studentList = db.GetStudents().Where(s => s.Class == selectedClass).ToList();
                UpdateStudentListView("Tất cả");
            }
        }

        // Xử lý khung hình từ camera
        private void ProcessFrame(object sender, EventArgs e)
        {
            try
            {
                using (Mat frame = _capture.QueryFrame())
                {
                    if (frame != null)
                    {
                        Image<Bgr, Byte> imageFrame = frame.ToImage<Bgr, Byte>();
                        DetectFaces(imageFrame);
                        pictureBox.Image = imageFrame.ToBitmap();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi khung hình: " + ex.Message);
                Application.Idle -= ProcessFrame;
            }
        }

        // Phát hiện khuôn mặt và xử lý điểm danh
        private void DetectFaces(Image<Bgr, Byte> image)
        {
            using (Image<Gray, Byte> grayFrame = image.Convert<Gray, Byte>())
            {
                Rectangle[] faces = _faceCascade.DetectMultiScale(grayFrame, 1.1, 10, Size.Empty);
                foreach (var face in faces)
                {
                    image.Draw(face, new Bgr(Color.Red), 2);

                    if (!isNewStudentMode && RecognizeFace(image, face))
                    {
                        image.Draw(face, new Bgr(Color.Green), 2);
                    }
                }
            }
        }

        private bool RecognizeFace(Image<Bgr, Byte> image, Rectangle faceRect)
        {
            Image<Bgr, Byte> faceImage = image.Copy(faceRect).Resize(100, 100, Inter.Linear);
            byte[] faceData = faceImage.ToJpegData();

            using (var db = new FaceDetectionAppContext())
            {
                var student = studentList.FirstOrDefault(s => s.FaceData.SequenceEqual(faceData));

                if (student != null)
                {
                    var attendanceRecord = new AttendanceRecord
                    {
                        NameStudent = student.Name,
                        AttendanceTime = DateTime.Now,
                        Status = true
                    };

                    db.AddAttendanceRecord(attendanceRecord);
                    studentList.First(s => s.Id == student.Id) = true; // Đánh dấu đã điểm danh
                    UpdateStudentListView("Đã điểm danh");
                    return true;
                }
            }
            return false;
        }

        private void UpdateStudentListView(string filter)
        {
            lstStudentAttendance.Items.Clear();

            IEnumerable<Student> filteredList = studentList;
            if (filter == "Đã điểm danh")
            {
                filteredList = studentList.Where(s => s.IsAttended);
            }
            else if (filter == "Chưa điểm danh")
            {
                filteredList = studentList.Where(s => !s.IsAttended);
            }

            foreach (var student in filteredList)
            {
                var item = new ListViewItem(new[] { student.Id.ToString(), student.Name, student.Class });
                item.SubItems.Add(student.IsAttended ? "✓" : "X");
                lstStudentAttendance.Items.Add(item);
            }
        }

        private void FilterAttendance(object sender, EventArgs e)
        {
            var selectedFilter = (sender as ComboBox)?.SelectedItem.ToString();
            UpdateStudentListView(selectedFilter);
        }

        protected override void OnClosed(EventArgs e)
        {
            _capture?.Dispose();
            base.OnClosed(e);
        }
    }

    partial class MainForm
    {
        private System.Windows.Forms.PictureBox pictureBox;
        private System.Windows.Forms.TextBox txtStudentName;
        private System.Windows.Forms.TextBox txtStudentClass;
        private System.Windows.Forms.Button btnNewStudentMode;
        private System.Windows.Forms.Button btnAttendanceMode;
        private System.Windows.Forms.Button btnCapture;
        private System.Windows.Forms.ListBox lstAttendance;
        private System.Windows.Forms.ComboBox cmbClass;
        private System.Windows.Forms.ComboBox cmbFilter;
        private System.Windows.Forms.ListView lstStudentAttendance;

        private void InitializeComponent()
        {
            this.pictureBox = new System.Windows.Forms.PictureBox();
            this.txtStudentName = new System.Windows.Forms.TextBox();
            this.txtStudentClass = new System.Windows.Forms.TextBox();
            this.btnNewStudentMode = new System.Windows.Forms.Button();
            this.btnAttendanceMode = new System.Windows.Forms.Button();
            this.btnCapture = new System.Windows.Forms.Button();
            this.lstAttendance = new System.Windows.Forms.ListBox();
            this.cmbClass = new System.Windows.Forms.ComboBox();
            this.cmbFilter = new System.Windows.Forms.ComboBox();
            this.lstStudentAttendance = new System.Windows.Forms.ListView();

            ((System.ComponentModel.ISupportInitialize)(this.pictureBox)).BeginInit();
            this.SuspendLayout();

            // pictureBox
            this.pictureBox.Location = new System.Drawing.Point(12, 12);
            this.pictureBox.Size = new System.Drawing.Size(400, 400);

            // txtStudentName
            this.txtStudentName.Location = new System.Drawing.Point(490, 55);
            this.txtStudentName.Size = new System.Drawing.Size(200, 20);
            this.txtStudentName.PlaceholderText = "Tên học sinh mới";
            this.txtStudentName.Visible = false;

            // txtStudentClass
            this.txtStudentClass.Location = new System.Drawing.Point(490, 90);
            this.txtStudentClass.Size = new System.Drawing.Size(200, 20);
            this.txtStudentClass.PlaceholderText = "Lớp";
            this.txtStudentClass.Visible = false;

            // btnNewStudentMode
            this.btnNewStudentMode.Location = new System.Drawing.Point(450, 10);
            this.btnNewStudentMode.Size = new System.Drawing.Size(150, 40);
            this.btnNewStudentMode.Text = "Thêm sinh viên mới";
            this.btnNewStudentMode.BackColor = Color.FromArgb(59, 218, 216);
            this.btnNewStudentMode.Click += new EventHandler(SwitchToNewStudentMode);

            // btnAttendanceMode
            this.btnAttendanceMode.Location = new System.Drawing.Point(600, 10);
            this.btnAttendanceMode.Size = new System.Drawing.Size(150, 40);
            this.btnAttendanceMode.Text = "Tự động điểm danh";
            this.btnAttendanceMode.BackColor = Color.FromArgb(59, 218, 216);
            this.btnAttendanceMode.Click += new EventHandler(SwitchToAttendanceMode);

            // btnCapture
            this.btnCapture.Location = new System.Drawing.Point(490, 220);
            this.btnCapture.Size = new System.Drawing.Size(200, 30);
            this.btnCapture.Text = "Chụp";
            this.btnCapture.BackColor = Color.FromArgb(59, 218, 216);
            this.btnCapture.Visible = false;
            this.btnCapture.Click += new EventHandler(CaptureNewStudentFace);

            // cmbClass
            this.cmbClass.Location = new System.Drawing.Point(450, 70);
            this.cmbClass.Size = new System.Drawing.Size(200, 20);
            this.cmbClass.DropDownStyle = ComboBoxStyle.DropDownList;

            // cmbFilter
            this.cmbFilter.Location = new System.Drawing.Point(450, 100);
            this.cmbFilter.Size = new System.Drawing.Size(200, 20);
            this.cmbFilter.DropDownStyle = ComboBoxStyle.DropDownList;
            this.cmbFilter.Items.AddRange(new string[] { "Tất cả", "Đã điểm danh", "Chưa điểm danh" });
            this.cmbFilter.SelectedIndexChanged += FilterAttendance;

            // lstStudentAttendance
            this.lstStudentAttendance.Location = new System.Drawing.Point(450, 130);
            this.lstStudentAttendance.Size = new System.Drawing.Size(300, 300);
            this.lstStudentAttendance.View = View.Details;
            this.lstStudentAttendance.Columns.Add("ID", 50);
            this.lstStudentAttendance.Columns.Add("Tên", 150);
            this.lstStudentAttendance.Columns.Add("Lớp", 100);
            this.lstStudentAttendance.Columns.Add("Trạng thái", 50);

            // MainForm
            this.Controls.Add(this.pictureBox);
            this.Controls.Add(this.txtStudentName);
            this.Controls.Add(this.txtStudentClass);
            this.Controls.Add(this.btnNewStudentMode);
            this.Controls.Add(this.btnAttendanceMode);
            this.Controls.Add(this.btnCapture);
            this.Controls.Add(this.cmbClass);
            this.Controls.Add(this.cmbFilter);
            this.Controls.Add(this.lstStudentAttendance);

            this.Text = "Hệ Thống Điểm Danh Khuôn Mặt";
            ((System.ComponentModel.ISupportInitialize)(this.pictureBox)).EndInit();
            this.ResumeLayout(false);
        }
    }
}
